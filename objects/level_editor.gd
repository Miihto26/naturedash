extends Node2D

# SET TO TRUE AND FALSE TO TOGGLE LEVEL EDITOR OR NOT
const in_edit_mode: bool = false

var current_level_name = Signals.songs[Signals.CurrentSong]

@onready var background_manager_scene = preload("res://art/backgrounds/BackgroundManager.tscn")
var current_background: Node = null

# time it takes falling key to reach critical spot
var fk_fall_time: float = 1.875
var fk_output_arr = [[], []]

var level_info = {
	"1-ENTER-EZRA" = {
		"fk_times": "[[4.70785713195801, 7.08500003814697, 9.49697303771973, 11.1281747817993, 13.4849996566772, 17.4759292602539, 19.9082202911377, 22.3085823059082, 23.8875389099121, 26.2762928009033, 30.2759284973145, 32.6762924194336, 35.0766563415527, 36.7078590393066, 39.0849990844727], [6.23166656494141, 7.89769840240479, 10.2980613708496, 12.7071313858032, 14.2744789123535, 15.0755672454834, 15.89697265625, 16.6980609893799, 19.098424911499, 20.6744785308838, 23.0980606079102, 25.4984245300293, 27.0744781494141, 27.8755664825439, 28.7085819244385, 29.5067691802979, 31.8752021789551, 33.474479675293, 35.8980598449707, 38.275203704834, 39.9064064025879, 40.7074928283691, 41.4766540527344, 42.2980613708496]]", #up and down times, respectively
		"spikes_times": "[[], []]",
		"music": load("res://music/1-EnterEzra.mp3")
	},
	
	"2-THIS-IS-MY-WORLD" = {
		"fk_times": "[[3.66295909881592, 4.63239240646362, 5.63665533065796, 6.31874179840088, 6.9253625869751, 7.57842445373535, 8.24890041351318, 14.2744789123535, 14.9594669342041, 15.6299438476563, 16.2481746673584, 16.9534816741943, 17.5513954162598, 18.1783332824707, 18.8720302581787, 40.9425964355469, 43.6099891662598, 46.2019157409668, 48.9737968444824, 51.6092643737793, 52.8689460754395, 54.2766571044922, 55.6292190551758, 56.9324378967285, 58.2443656921387, 59.6636848449707, 61.0075378417969, 64.9520263671875, 65.5702590942383, 66.1913909912109, 66.841552734375, 67.6078109741211, 68.2492599487305, 68.8994216918945, 69.5611877441406, 71.2475433349609, 72.9309844970703, 74.2342071533203, 75.5983810424805, 76.8899917602539, 78.2860870361328, 79.5864028930664, 80.9418716430664, 82.9591064453125, 86.2969741821289, 87.3534774780273, 88.2706680297852, 88.9527587890625, 89.9454116821289, 90.9380645751953, 91.6085357666016, 92.5895767211914, 93.5619125366211, 94.2643203735352, 95.6517105102539, 96.9317092895508, 98.2552490234375, 99.6078109741211, 100.931350708008, 102.30712890625, 103.479736328125], [8.96291351318359, 9.58114528656006, 10.2748413085938, 10.9366102218628, 11.6186962127686, 12.2282199859619, 12.9219160079956, 13.5401477813721, 18.8836402893066, 22.2534351348877, 38.2984237670898, 40.9309844970703, 43.6186943054199, 46.1903076171875, 48.985408782959, 52.2071762084961, 53.5510330200195, 54.926815032959, 56.3025970458984, 57.570987701416, 58.9699897766113, 60.2586975097656, 61.6141624450684, 62.2643203735352, 62.9144821166992, 63.5762481689453, 64.2264022827148, 67.5991058349609, 68.260871887207, 68.887809753418, 69.5727996826172, 70.295524597168, 72.3446807861328, 73.5927581787109, 74.8611450195313, 76.2601470947266, 77.5604629516602, 78.9594650268555, 80.248176574707, 81.6036376953125, 82.2741165161133, 83.6208724975586, 84.6425476074219, 85.591667175293, 88.9643630981445, 89.9541168212891, 90.958381652832, 91.6201477050781, 92.6128005981445, 93.5822372436523]]",
		"spikes_times": "[[],[24.9527549743652, 27.5969276428223, 30.2759284973145, 32.9520301818848, 35.5874938964844, 104.97452545166, 106.329986572266, 107.609985351563, 108.846450805664, 110.242553710938, 111.61833190918, 112.941871643066, 114.210258483887]]",
		"music": load("res://music/2-THISISMYWORLD.mp3")
	},
	
	"3-OUTTA-MY-WAY" = {
		"fk_times": "[[3.61942195892334, 4.28119039535522, 4.93134927749634, 5.60472774505615, 6.27520370483398, 6.91665554046631, 7.56681442260742, 8.2692174911499, 9.15447807312012, 11.5983791351318, 11.9292631149292, 12.2804651260376, 12.9219160079956, 13.6359300613403, 14.4457263946533, 16.9534816741943, 17.2727546691895, 17.5920295715332, 18.2770175933838, 18.9155673980713, 19.7485828399658, 22.2969722747803, 22.616247177124, 22.9384231567383, 23.5769729614258, 24.2822780609131, 25.1036853790283, 25.61452293396, 26.2530727386475, 26.938060760498, 27.7594661712646, 28.2703056335449, 28.952392578125, 29.6141605377197, 30.2759284973145, 31.0334815979004, 31.6517105102539, 32.2815551757813, 32.9201011657715, 33.5818710327148, 34.2871780395508, 34.9576530456543, 41.1225509643555, 41.656608581543, 43.6186943054199, 43.9495811462402, 46.4525947570801, 46.9594688415527, 48.9099426269531, 49.284366607666, 51.5976524353027, 52.2797393798828, 52.9415092468262, 53.1127548217773, 53.5191040039063, 54.2969741821289, 54.9355201721191, 55.5972900390625, 55.800464630127, 56.3530044555664, 56.9527549743652, 57.5942077636719, 58.2530708312988, 58.4475402832031, 58.9786949157715, 59.5882186889648, 60.2906227111816, 60.9088554382324, 61.1120300292969, 61.6257705688477, 67.6194229125977, 68.2695770263672, 68.9632797241211, 69.6685791015625, 70.2752075195313, 70.9485855102539, 71.6306686401367, 72.3127517700195, 72.9425964355469, 73.3054046630859, 73.6449966430664, 75.5867691040039, 75.8973388671875, 76.24853515625, 78.4573364257813, 81.069580078125, 83.5889434814453, 84.964729309082, 94.2759323120117, 94.6155242919922, 94.9580154418945, 97.1029586791992, 97.6254043579102, 99.5991058349609, 99.9386978149414, 102.243278503418, 102.59447479248, 105.081916809082, 105.636291503906, 107.746406555176, 108.29207611084, 110.265769958496, 110.605361938477, 113.113121032715, 113.623954772949], [9.00645160675049, 9.33733558654785, 9.62468242645264, 10.1471319198608, 10.8930721282959, 11.7580156326294, 14.3064060211182, 14.6053619384766, 14.9594669342041, 15.5980167388916, 16.2278575897217, 17.0928001403809, 19.5976524353027, 19.9198303222656, 20.2797393798828, 20.9415073394775, 21.6468143463135, 22.4566097259521, 24.9411449432373, 25.272029876709, 27.6085376739502, 27.9510326385498, 35.6194229125977, 36.2928009033203, 36.9429588317871, 37.5727996826172, 38.2635955810547, 38.9369735717773, 39.5987396240234, 40.2605094909668, 40.9425964355469, 41.3170166015625, 43.8015518188477, 44.268856048584, 46.2744789123535, 46.6053619384766, 49.069580078125, 49.6036376953125, 51.6208724975586, 52.2710304260254, 52.9415092468262, 53.101146697998, 53.507495880127, 54.2969741821289, 54.9355201721191, 55.6089019775391, 55.800464630127, 56.3548431396484, 56.9579010009766, 57.5942077636719, 58.2646827697754, 58.4475402832031, 58.9699897766113, 59.6085357666016, 60.2819175720215, 60.9204635620117, 61.1120300292969, 61.6344795227051, 62.2643203735352, 62.9376983642578, 63.6313934326172, 64.2380142211914, 64.9636383056641, 65.6021881103516, 66.2958831787109, 66.9576568603516, 73.0906219482422, 75.7464065551758, 78.2976989746094, 78.6285858154297, 78.9594650268555, 80.9099426269531, 81.25244140625, 81.5920257568359, 83.59765625, 84.964729309082, 86.2969741821289, 87.5972900390625, 88.9092178344727, 90.2850036621094, 91.5766067504883, 92.8566131591797, 94.4471740722656, 96.9201049804688, 97.2742080688477, 99.7471313476563, 100.260871887207, 102.414520263672, 102.925361633301, 104.919380187988, 105.273483276367, 107.578063964844, 107.929260253906, 110.434112548828, 110.947860717773, 112.941871643066, 113.272758483887]]",
		"spikes_times": "[[],[]]",
		"music": load("res://music/3-OuttaMyWay.mp3")
	},
	
	"4-GRAND-SLAM" = {
		"fk_times": "[[4.12155342102051, 4.82395696640015, 5.52926301956177, 6.25488662719727, 6.98921775817871, 7.70613384246826, 8.39982986450195, 10.4344787597656, 10.8088998794556, 13.4211454391479, 13.6997842788696, 14.1061334609985, 15.7576522827148, 16.2713947296143, 16.4310321807861, 16.590669631958, 19.9285373687744, 21.527811050415, 22.221508026123, 22.9152050018311, 23.6408271789551, 27.3734359741211, 28.122278213501, 28.7811450958252, 29.4661331176758, 33.2103500366211, 33.5818710327148, 33.9446830749512, 34.3074951171875, 34.6499900817871, 35.0128021240234, 35.3640022277832, 35.715202331543, 36.0780143737793, 36.4524383544922, 36.8355674743652, 37.186767578125, 37.5495796203613, 37.9240036010742, 38.2635955810547, 38.6380157470703, 41.8917121887207, 42.2661323547363, 42.6289443969727, 42.9685363769531, 43.3632774353027, 43.7144775390625, 44.0569725036621, 44.4313926696777, 47.7170181274414, 48.0769271850586, 48.4629592895508, 48.8141593933105, 49.1885833740234, 49.5513954162598, 49.8909873962402, 50.2973365783691, 50.6369285583496, 51.0548858642578, 51.3857727050781, 51.7485809326172, 52.0997848510742, 52.4306678771973, 52.7296257019043, 53.1766090393066, 54.0821876525879, 54.2650451660156, 54.7236404418945, 55.1299896240234, 55.3215522766113, 55.5334358215332, 55.7162933349609, 55.8875389099121, 56.0791053771973, 56.4419174194336, 57.1675415039063, 57.8496246337891, 58.6158828735352, 59.3850440979004, 60.110668182373, 60.7811470031738, 61.5183792114258, 65.1755218505859, 65.9011459350586, 68.0896224975586, 71.0008239746094, 73.9033203125, 76.8145217895508, 79.7373352050781, 80.1001510620117, 80.4716644287109, 80.8344802856445, 81.2089004516602, 81.5601043701172, 81.9461364746094, 82.2973327636719, 85.5829620361328, 85.9225540161133, 86.2650451660156, 86.6278533935547, 86.9674453735352, 87.3215560913086, 87.7046813964844, 88.0878143310547, 88.4622344970703, 88.8134384155273, 89.1443176269531, 89.5709838867188, 89.9221878051758, 90.2646789550781, 90.607177734375, 90.9903030395508, 94.2643203735352, 94.6068115234375, 94.9696273803711, 95.3324356079102, 95.727180480957, 96.0580596923828, 96.4208755493164, 96.8243179321289, 100.046089172363, 100.420509338379, 100.792030334473, 101.186767578125, 101.474113464355, 101.868858337402, 102.135887145996, 102.426132202148, 102.617698669434, 114.584686279297, 117.55103302002], [9.90332221984863, 10.628945350647, 11.1717119216919, 12.8261337280273, 13.5604648590088, 17.0057258605957, 18.6485366821289, 19.2145233154297, 19.3857707977295, 19.5570182800293, 24.430305480957, 25.1878566741943, 25.8815536499023, 26.5317115783691, 30.2323913574219, 31.0015525817871, 31.7039566040039, 32.333797454834, 39.0211448669434, 39.395565032959, 39.7380599975586, 40.0776519775391, 40.3882217407227, 40.7510299682617, 41.113842010498, 41.5085830688477, 44.814525604248, 45.1889457702637, 45.5401458740234, 45.8797378540039, 46.2541618347168, 46.6285820007324, 46.9681739807129, 47.3309860229492, 47.7257270812988, 48.1001472473145, 48.4716682434082, 48.8257713317871, 49.1972885131836, 49.5601005554199, 49.9025955200195, 50.2857246398926, 50.6485366821289, 51.0432777404785, 51.3857727050781, 51.7689018249512, 52.1113929748535, 52.450984954834, 52.7383346557617, 53.1882209777832, 53.539421081543, 54.169261932373, 54.4130706787109, 62.2875366210938, 62.9899444580078, 63.7155685424805, 64.4527969360352, 66.5861358642578, 67.3001480102539, 68.1099395751953, 70.9892196655273, 73.9236373901367, 76.8261337280273, 82.6688537597656, 83.0548858642578, 83.4177017211914, 83.7369689941406, 84.0997848510742, 84.4625930786133, 84.8254089355469, 85.1882171630859, 85.5829620361328, 85.9341583251953, 86.2766571044922, 86.6278533935547, 86.9674453735352, 87.3302612304688, 87.7162933349609, 88.1110305786133, 91.3328018188477, 91.7159271240234, 92.0990600585938, 92.4734802246094, 92.8043670654297, 93.1671752929688, 93.5299911499023, 93.8811874389648, 97.1435928344727, 97.538330078125, 97.9011459350586, 98.2755661010742, 98.6499862670898, 98.9692611694336, 99.3088531494141, 99.662956237793, 100.05770111084, 100.429214477539, 100.792030334473, 101.166450500488, 101.485725402832, 101.848533630371, 102.159103393555, 102.498695373535, 102.841194152832, 120.473846435547, 123.373435974121]]",
		"spikes_times": "[[],[]]",
		"music": load("res://music/4-GRANDSLAM.mp3")
	},
	
	"5-LUNABLADE" = {
		"fk_times": "[[0.77207493782043, 2.09561228752136, 3.45978450775146, 4.6759295463562, 5.12291383743286, 5.6134352684021, 10.2748413085938, 10.5970182418823, 10.9250001907349, 11.4503517150879, 12.7942066192627, 14.1786956787109, 15.3222789764404, 15.7808723449707, 16.291711807251, 16.7938442230225, 18.1144790649414, 19.4583339691162, 20.7702598571777, 21.8703060150146, 23.1386966705322, 23.2983341217041, 23.4811897277832, 23.8323917388916, 24.1632766723633, 24.5464057922363, 25.7741603851318, 26.1892185211182, 26.7987422943115, 28.4734802246094, 28.6331176757813, 28.8769283294678, 29.1555671691895, 29.4864521026611, 29.89280128479, 31.108943939209, 31.7997398376465, 32.4528007507324, 36.7833213806152, 38.1039581298828, 39.4391059875488, 40.7597389221191, 42.1152038574219, 42.4664077758789, 42.7885818481445, 43.128173828125, 43.4822807312012, 43.8015518188477, 44.1411437988281, 44.4836387634277, 46.1148414611816, 46.6372909545898, 47.812801361084, 48.2917137145996, 48.770622253418, 49.1131172180176, 49.7632751464844, 50.158016204834, 50.7878570556641, 52.9734344482422, 53.3159294128418, 53.6148872375488, 54.1054077148438, 56.2387428283691, 57.1559295654297, 58.3401489257813, 58.6158828735352, 59.1180152893066, 59.811710357666, 61.6344795227051, 62.4994201660156, 63.4804611206055, 63.8113479614258, 64.4411926269531, 64.8040008544922, 65.1552047729492, 66.5222778320313, 66.9808731079102, 67.4597854614258, 70.4261322021484, 72.2924346923828, 73.1022338867188, 75.6419143676758, 75.949577331543, 76.7709884643555, 77.1018676757813, 77.421142578125, 78.2860870361328, 78.6053619384766, 79.4819183349609, 79.8127975463867, 80.1320724487305, 80.9621887207031, 81.2611465454102, 82.1580123901367, 82.4685821533203, 82.7994689941406, 83.6731185913086, 83.9720764160156, 84.7934799194336, 85.1330718994141, 85.4233245849609, 86.1460418701172, 86.8194198608398, 87.4695816040039, 88.13134765625, 88.3461303710938, 88.5057678222656, 88.7931213378906, 89.5187377929688, 90.1166534423828, 90.308219909668, 90.5201034545898, 90.7871322631836, 91.4924392700195, 92.1629104614258, 92.8043670654297, 92.9727096557617, 93.1555633544922, 93.4748382568359, 94.1569290161133, 94.8186950683594, 95.492073059082, 95.6633224487305, 95.8316650390625, 96.1103057861328, 96.7720718383789, 97.422233581543, 98.1159286499023, 98.946044921875, 99.2682189941406, 103.311393737793, 103.758377075195, 104.292434692383, 104.803276062012, 105.496971130371, 106.135520935059, 106.745048522949, 107.447448730469, 108.120826721191, 108.791305541992, 109.133796691895, 109.485000610352, 109.815887451172, 110.138061523438, 110.796928405762, 111.449989318848, 112.152389526367, 112.793846130371, 113.444000244141, 114.306045532227, 114.636924743652, 115.458335876465, 116.120101928711, 116.749946594238, 117.423324584961, 118.082191467285, 118.807815551758, 119.780143737793, 120.450622558594, 120.610260009766, 121.817695617676, 121.997650146484, 122.200828552246, 122.479469299316, 122.850982666016, 123.181869506836, 124.792755126953, 125.466133117676, 126.937698364258, 127.81135559082, 129.58186340332], [4.93134927749634, 5.30577087402344, 6.12717723846436, 7.45942211151123, 8.79166698455811, 10.1064968109131, 10.4460887908936, 10.7885828018188, 11.1194667816162, 15.6183338165283, 15.9724369049072, 21.7948417663574, 22.0183334350586, 22.1576538085938, 23.2025508880615, 24.494161605835, 24.7728004455566, 25.1443195343018, 25.4548873901367, 25.8699436187744, 26.4997844696045, 27.0976982116699, 27.469217300415, 27.77978515625, 28.1309871673584, 28.557653427124, 29.8376522064209, 30.0205097198486, 30.1801490783691, 30.4355659484863, 30.8099899291992, 31.492073059082, 32.1306228637695, 32.7836837768555, 34.020149230957, 35.4713935852051, 42.1268157958984, 42.4780158996582, 42.7769737243652, 43.1194686889648, 44.8261337280273, 45.1773338317871, 45.4966087341309, 45.8391036987305, 46.4457244873047, 46.9681739807129, 47.4703063964844, 47.9927558898926, 49.2930717468262, 51.4902610778809, 52.1433219909668, 52.7934799194336, 53.1330718994141, 53.487174987793, 53.7629127502441, 55.0022773742676, 55.7685356140137, 57.5825958251953, 58.1805114746094, 58.4794654846191, 58.938060760498, 60.3544769287109, 61.1352500915527, 62.9057693481445, 63.6197814941406, 63.9709854125977, 65.6776504516602, 66.2001037597656, 67.767448425293, 68.3450469970703, 68.8674926757813, 69.3580169677734, 69.7643661499023, 70.9572906494141, 71.8019180297852, 73.5927581787109, 74.1471328735352, 74.4983367919922, 74.8088989257813, 75.1397857666016, 75.4474487304688, 75.8102569580078, 76.132438659668, 76.9306259155273, 77.252799987793, 78.1061325073242, 78.4341125488281, 78.8085403442383, 79.6415557861328, 79.9608306884766, 80.7938461303711, 81.1131210327148, 81.4759292602539, 82.3089447021484, 82.6282196044922, 83.4815521240234, 83.8124389648438, 84.1752471923828, 84.9531173706055, 85.2956085205078, 85.7948379516602, 86.137336730957, 86.7991027832031, 87.4695816040039, 88.13134765625, 88.3548431396484, 88.5144805908203, 88.8047256469727, 89.5187377929688, 90.1253662109375, 90.3401489257813, 90.5317153930664, 90.8074493408203, 91.4924392700195, 92.1745223999023, 92.7811431884766, 92.9959259033203, 93.1758880615234, 93.4980621337891, 94.1366119384766, 94.8303070068359, 95.4804611206055, 95.6836395263672, 95.8548889160156, 96.1306228637695, 98.7457733154297, 99.0969696044922, 99.4481735229492, 100.130264282227, 100.803642272949, 101.421867370605, 102.103958129883, 102.820869445801, 103.598739624023, 103.929626464844, 108.962547302246, 109.293434143066, 109.635932922363, 113.966453552246, 114.47728729248, 114.967811584473, 119.449264526367, 120.142959594727, 120.526084899902, 120.781509399414, 121.132713317871, 121.475204467773, 121.901870727539, 123.524368286133, 123.855247497559, 124.151306152344, 124.473480224609, 126.40364074707, 128.226409912109, 129.166809082031, 130.191390991211, 130.713836669922, 131.096969604492]]",
		"spikes_times": "[[],[]]",
		"music": load("res://music/5-Lunablade.mp3")
	},
	
	"6-WHITE-WINGS-OF-WONDER" = {
		"fk_times": "[[15.6183338165283, 15.9405097961426, 16.280101776123, 16.6022796630859, 16.933162689209, 17.3046817779541, 17.6239566802979, 17.9229145050049, 18.2450904846191, 18.799467086792, 19.2783794403076, 19.4496250152588, 20.5699882507324, 22.317289352417, 22.4769268035889, 22.6394672393799, 22.8078117370605, 22.9703521728516, 23.2983341217041, 24.9643650054932, 25.2836399078369, 25.4548873901367, 25.6261329650879, 25.9454078674316, 27.6636848449707, 27.9829597473145, 28.1425971984863, 28.3022327423096, 28.6215076446533, 28.9843196868896, 29.2832775115967, 29.4225959777832, 29.593843460083, 29.9566555023193, 30.4355659484863, 30.7229156494141, 31.2772903442383, 31.6197853088379, 32.1219177246094, 32.9520301818848, 33.4425506591797, 34.6064529418945, 36.9313507080078, 37.433479309082, 37.9559288024902, 39.5871315002441, 40.1328010559082, 41.2618713378906, 42.5970191955566, 43.5867691040039, 43.9089469909668, 45.2731170654297, 46.3064041137695, 46.9043197631836, 47.5544776916504, 47.8766555786133, 48.0682182312012, 49.6036376953125, 50.6369285583496, 51.2899894714355, 51.9401473999023, 52.2797393798828, 52.6106224060059, 53.2723922729492, 53.455249786377, 53.8064498901367, 54.6075401306152, 55.2983322143555, 55.6089019775391, 56.2706680297852, 56.4506225585938, 57.1675415039063, 57.5071296691895, 57.9657249450684, 58.1253623962402, 58.5752487182617, 58.7552032470703, 59.0860900878906, 59.2370185852051, 59.5882186889648, 60.2906227111816, 60.9436836242676, 61.4342079162598, 61.988582611084, 62.9144821166992, 63.5994644165039, 64.2815551757813, 64.4411926269531, 65.1435928344727, 65.6341171264648, 66.2958831787109, 66.9257278442383, 67.4278564453125, 67.8022766113281, 68.2492599487305, 68.7601013183594, 69.2622299194336, 69.6134338378906, 70.0836410522461, 70.9892196655273, 71.5987396240234, 72.1647262573242, 72.6117095947266, 73.604362487793, 74.254524230957, 84.9415054321289, 86.2853622436523, 87.5972900390625, 88.8889007568359, 90.2599411010742, 90.5955657958984, 90.9467697143555, 91.2573318481445, 91.5882186889648, 91.7594680786133, 91.9278106689453, 92.0990600585938, 92.2703094482422, 92.4299468994141, 92.601188659668, 92.7724380493164, 92.9320755004883, 93.1120300292969, 93.2716674804688, 93.4661331176758, 93.6257705688477, 93.7941131591797, 93.9885864257813, 95.2772903442383, 95.7794189453125, 96.1538467407227, 96.6211471557617, 97.1232757568359, 97.422233581543, 97.7328033447266, 98.2639541625977, 98.4468154907227, 98.7544784545898, 99.2769241333008, 99.7587432861328, 100.089622497559, 100.620780944824, 100.951667785645, 101.636657714844, 103.587135314941, 103.918014526367, 104.248901367188, 104.954208374023, 105.465042114258, 106.948219299316, 107.59838104248, 108.962547302246, 109.145408630371, 110.947860717773, 112.312026977539, 112.953483581543, 115.586044311523, 116.120101928711, 117.60327911377, 118.285362243652, 118.935523986816, 119.118377685547, 119.768539428711, 120.270668029785, 120.909217834473, 121.658058166504, 122.093437194824, 122.444633483887, 122.766815185547, 123.245727539063, 123.416969299316, 123.939422607422, 124.142593383789, 124.450263977051, 124.601188659668, 124.781143188477, 125.303596496582, 125.442916870117, 125.945045471191, 126.638748168945, 127.117660522461, 127.436920166016, 128.249618530273, 128.963638305664, 129.602188110352, 129.7734375, 130.462387084961, 130.969268798828, 131.607818603516, 131.950302124023, 132.452438354492, 132.620788574219, 133.122909545898, 133.442184448242, 133.784683227539, 133.944320678711, 134.478378295898, 134.63801574707, 134.968902587891, 135.288177490234, 135.471038818359, 135.938339233398, 136.292434692383, 136.623321533203, 136.79167175293, 137.305404663086, 137.433120727539, 137.784317016602, 137.967178344727, 138.916290283203, 139.255889892578, 139.746398925781, 140.068588256836, 140.38786315918, 140.834838867188, 141.249893188477, 141.612716674805, 141.923278808594, 142.265777587891, 142.62858581543, 142.947860717773, 143.278747558594, 143.61833190918, 143.960830688477, 144.323638916016, 144.909942626953, 145.081192016602, 145.25244140625, 145.420776367188, 145.58332824707, 145.731353759766, 145.91130065918, 146.073837280273, 147.617965698242, 147.757293701172, 147.916931152344, 148.088180541992, 148.279739379883, 148.419052124023, 148.590301513672, 148.749938964844, 149.379791259766, 150.308578491211, 150.468215942383, 150.627853393555, 150.787490844727, 150.935516357422, 151.095153808594, 151.266403198242, 151.417343139648, 152.932434082031, 153.092071533203, 153.272033691406, 153.454879760742, 153.614517211914, 153.774154663086, 153.933792114258, 154.09342956543, 154.711669921875, 154.871307373047, 155.596923828125, 155.768173217773, 155.927810668945, 156.11067199707, 156.258697509766, 156.418334960938, 156.589584350586, 156.749221801758, 158.252716064453, 158.447174072266, 158.615524291992, 158.775161743164, 158.946411132813, 159.106048583984, 159.277282714844, 159.448532104492, 160.089981079102, 160.258331298828, 160.943328857422, 162.211715698242, 163.575881958008, 164.911026000977, 171.319732666016, 171.64192199707, 172.57942199707, 172.910308837891, 173.955200195313, 174.306411743164, 175.267135620117, 175.629943847656, 176.622589111328, 176.962188720703, 177.91130065918, 178.265411376953, 179.255157470703, 179.609268188477, 180.610626220703, 180.961822509766], [15.6618709564209, 16.3033218383789, 16.9650897979736, 17.6355667114258, 18.2770175933838, 18.5846824645996, 19.1071319580078, 20.2274951934814, 20.8892631530762, 21.048900604248, 21.2404651641846, 21.4117126464844, 21.591667175293, 21.9341602325439, 23.6089000701904, 23.9281749725342, 24.1197395324707, 24.2822780609131, 24.6218700408936, 26.308219909668, 26.6274948120117, 26.7987422943115, 26.9583778381348, 27.2776527404785, 28.9756126403809, 29.2629585266113, 29.4342060089111, 29.6257705688477, 29.9653625488281, 30.287540435791, 30.5835952758789, 30.914478302002, 31.9825973510742, 33.2742080688477, 34.2871780395508, 34.7776985168457, 35.6078109741211, 36.2811889648438, 38.2548866271973, 38.8847274780273, 39.2678565979004, 39.9615516662598, 40.8903503417969, 41.4215087890625, 42.254524230957, 42.7769737243652, 44.0685844421387, 44.9306221008301, 45.4211463928223, 48.8896255493164, 50.2654075622559, 50.9591026306152, 51.6208724975586, 52.9415092468262, 53.6671333312988, 54.1054077148438, 54.4130706787109, 54.9703521728516, 55.9513931274414, 56.7815093994141, 57.3358840942383, 58.308219909668, 59.4372901916504, 59.9510307312012, 60.601188659668, 61.2716674804688, 61.7970199584961, 63.2569732666016, 63.9506683349609, 64.7923889160156, 65.3061370849609, 65.9562911987305, 66.1159286499023, 66.594841003418, 67.0969696044922, 67.9619140625, 68.5801467895508, 69.9123916625977, 70.6264038085938, 70.788948059082, 71.2678604125977, 71.9064025878906, 72.5043182373047, 72.782958984375, 73.9236373901367, 84.964729309082, 86.2766571044922, 87.6089019775391, 88.8889007568359, 90.2530746459961, 90.607177734375, 90.9380645751953, 91.2660446166992, 91.6085357666016, 91.7681732177734, 91.9510345458984, 92.1193771362305, 92.2819137573242, 92.4502639770508, 92.6128005981445, 92.7927551269531, 92.9640045166016, 93.1439590454102, 93.3152008056641, 93.4980621337891, 93.6460876464844, 93.8173370361328, 93.9769744873047, 94.2527084350586, 94.9580154418945, 95.5994644165039, 95.9825973510742, 96.3134841918945, 96.9636383056641, 97.2829132080078, 97.5818710327148, 97.9243621826172, 98.6180648803711, 98.9257278442383, 99.6194229125977, 99.9183807373047, 100.269577026367, 102.275207519531, 102.893432617188, 104.066040039063, 104.600105285645, 105.282188415527, 106.210983276367, 107.255882263184, 108.280464172363, 109.644638061523, 110.265769958496, 111.61833190918, 111.801193237305, 114.274116516113, 115.940147399902, 116.941505432129, 117.922554016113, 118.604637145996, 119.426040649414, 119.928176879883, 120.601554870605, 121.272026062012, 121.431663513184, 121.794479370117, 122.595565795898, 123.588218688965, 124.952392578125, 126.275924682617, 126.798385620117, 127.309219360352, 128.589218139648, 129.294525146484, 130.124633789063, 130.618057250977, 130.786407470703, 131.300140380859, 132.257965087891, 132.783325195313, 133.28254699707, 133.656967163086, 134.147491455078, 134.817977905273, 135.778701782227, 136.153121948242, 136.951309204102, 138.071670532227, 139.578063964844, 139.91764831543, 140.216613769531, 140.547500610352, 141.069946289063, 141.432754516602, 141.763641357422, 142.082916259766, 142.434112548828, 142.788223266602, 143.095886230469, 143.438385009766, 143.769256591797, 144.132080078125, 144.439743041992, 146.253799438477, 146.445358276367, 146.628219604492, 146.819778442383, 146.999740600586, 147.159378051758, 147.321914672852, 148.897964477539, 149.551025390625, 151.588577270508, 151.768539428711, 151.939788818359, 152.119735717773, 152.302597045898, 152.473846435547, 152.633483886719, 152.781509399414, 154.264678955078, 154.819061279297, 156.920471191406, 157.143951416016, 157.303588867188, 157.486450195313, 157.666412353516, 157.805725097656, 157.956649780273, 158.104675292969, 159.587860107422, 160.174163818359, 180.642547607422, 180.953125]]",
		"spikes_times": "[[],[10.234206199646, 11.6186962127686, 12.8986959457397, 14.1903057098389, 166.2548828125, 167.587127685547, 168.910675048828, 170.231307983398]]",
		"music": load("res://music/6-WhiteWingsOfWonder.mp3")
	}
}


func _ready():
	Signals.StartLevel.connect(_on_StartLevel)
	print("CONNECTED START LEVEL SIGNAL")

func _on_StartLevel(level_name: String):
	print("STARTED")
	$MusicPlayer.stream = level_info.get(current_level_name).get("music")
	$MusicPlayer.play()
	
	load_level_background(current_level_name)
	
	if in_edit_mode:
		fk_output_arr = [[], []]
		Signals.KeyListenerPress.connect(KeyListenerPress)
	else:
		var fk_times = level_info.get(current_level_name).get("fk_times")
		var fk_times_arr = str_to_var(fk_times)
		
		var counter: int = 0
		for key in fk_times_arr:
			
			var button_name: String = ""
			match counter:
				0:
					button_name = "button_up_smack"
				1:
					button_name = "button_down_smack"
			
			for delay in key:
				SpawnFallingKey(button_name, delay)
			
			counter += 1
		
		# Handle spikes if they exist for this level
		if level_info.get(current_level_name).has("spikes_times"):
			var spikes_times = level_info.get(current_level_name).get("spikes_times")
			var spikes_times_arr = str_to_var(spikes_times)
			
			counter = 0
			for key in spikes_times_arr:
				var button_name: String = ""
				match counter:
					0:
						button_name = "button_up_smack"
					1:
						button_name = "button_down_smack"
				
				for delay in key:
					SpawnFallingSpikes(button_name, delay)
				
				counter += 1

func KeyListenerPress(button_name: String, array_num: int):
	print(str(array_num) + " " + str($MusicPlayer.get_playback_position()))
	fk_output_arr[array_num-1].append($MusicPlayer.get_playback_position() - fk_fall_time)

func SpawnFallingKey(button_name: String, delay: float):
	await get_tree().create_timer(delay).timeout
	Signals.CreateFallingKey.emit(button_name)

func SpawnFallingSpikes(button_name: String, delay: float):
	await get_tree().create_timer(delay).timeout
	Signals.CreateFallingSpikes.emit(button_name)

func _on_music_player_finished():
	print(fk_output_arr)
	
	if current_background:
		current_background.queue_free()
	
	Signals.CurrentSong += 1
	Signals.FinishLevel.emit(current_level_name) 

func load_level_background(level_name: String):
	print("Loaded Background")
	# Create background manager
	current_background = background_manager_scene.instantiate()
	add_child(current_background)
	
	if current_level_name == "1-ENTER-EZRA":
		current_background.scale_factor = 3.0
		current_background.centered = true
		current_background.offset = Vector2(0, 0)
	elif current_level_name == "2-THIS-IS-MY-WORLD":
		current_background.scale_factor = 3.0
		current_background.centered = true
		current_background.offset = Vector2(0, 125)
	elif current_level_name == "3-OUTTA-MY-WAY":
		current_background.scale_factor = 5.0
		current_background.centered = true
		current_background.offset = Vector2(0, 0)
	elif current_level_name == "4-GRAND-SLAM":
		current_background.scale_factor = 5.0
		current_background.centered = true
		current_background.offset = Vector2(0, 0)
	elif current_level_name == "5-LUNABLADE":
		current_background.scale_factor = 3.0
		current_background.centered = true
		current_background.offset = Vector2(0, 0)
	elif current_level_name == "6-WHITE-WINGS-OF-WONDER":
		current_background.scale_factor = 4.0
		current_background.centered = true
		current_background.offset = Vector2(50, 150)
	
	# Tell it which level to show background for
	current_background.set_level(current_level_name)
	
	await get_tree().create_timer(0.5).timeout  # Give it time to load
	current_background.print_debug_info()


func _on_button_pressed():
	print("SKIPPING LEVEL (dev)")
	
	if current_background:
		current_background.queue_free()
	
	Signals.CurrentSong += 1
	Signals.FinishLevel.emit(current_level_name) 


func _on_button_2_pressed():
	print("PREV LEVEL (dev)")
	
	if current_background:
		current_background.queue_free()
	
	Signals.CurrentSong -= 1
	Signals.FinishLevel.emit(current_level_name)
